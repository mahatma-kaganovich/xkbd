#!/bin/bash

_kill(){
	$kill &&
	if [ -x /usr/bin/pkill ]; then
		pkill -x xkbd -u "$EUID" ${@} && exit
	else
		killall -qw xkbd -u "$USER" ${@} && exit
	fi
}

conf=
kill=true
lock=
touch=true
n=
for i in "${@}"; do
	[ -n "$n" ] && eval $n='"$i"' && n='' ||
	case "$1" in
	--nokill)eval "${i#--no}"=false;;
	--lock-touch)
		# probably safer for multiple X
		which xinput >/dev/null && {
			xinput list --long|grep -q 'Touch mode:' || touch=false
		}
		n=lock
	;;
	--lock|--conf)n="${i#--}";;
	*)echo "$0: unknown param: $i
Params:
  --nokill
  --lock[-touch] <lock_program> - usual '--lock slock'
  --conf <xkbd_config>"; exit 1;;
	esac
done

[ -z "$conf" ] &&
for conf in /etc/xkbd-config.conf @pkgdatadir@/xkbd-kp-f.conf; do
	[ -e $conf ] && break
done

opt="-X -l -D 54 -k $conf -e $0 --nokill"

[ -n "$lock" ] && {
	$touch || {
		exec $lock
		exit
	}
	pgrep -x xkbd -u "$EUID" >/dev/null && xkbd=true || xkbd=false
	$xkbd || xkbd $opt &
	$lock
	$xkbd || _kill
	exit
}

_kill
# around bug in configuring keyboard over xorg.conf
setxkbmap
exec xkbd $opt
