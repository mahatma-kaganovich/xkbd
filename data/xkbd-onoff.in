#!/bin/bash

_help(){
echo "$0: unknown param: $i
Params:
  --nokill
  --[ext]lock [</usr/bin/slock>]
  --test-touch
  --sudo{1|2} <cmd>
  --conf <xkbd_config>
  --displays
  --xrdb
Examples:
  $0 --nokill --test-touch --lock - on .Xinitrc
  $0 --lock - lock with xkbd
 {
  # powersave script, NOPASSWORD in sudo
  nrg=/usr/sbin/ya-nrg
  # common cmd part
  xk=\"xkbd-onoff --sudo2 \$nrg restore --sudo1 \$nrg light 20 cores 0\"
  # run login/lock once, keep xkbd on unlock, powersave always
  \$xk save --lock --nokill
  # run power save/restore on XScreenSaver/dpms, lock by .Xresources xscreensaver.lock
  # or power track locks by elsewere if =false, powersave on battery
  xssevent \$xk auto --xrdb --extlock --xss &
 }

"
exit 1
}

_deflock(){
	[ -v $1 ] || return 1
	[ -n "${!1}" ] && return 0
	local i
	for i in /usr/bin/slock; do [ -x "$i" ] && break;done
	eval "$1=\"\$i\""
}

_kill(){
	if [ -x /usr/bin/pkill ]; then
		pkill -x xkbd -u "$EUID" ${@} && exit
	else
		killall -qw xkbd -u "$USER" ${@} && exit
	fi
}

pchk(){
	pgrep -x "${1##*/}" -u "$EUID" >/dev/null
}

_bool(){
	case "${1,,}" in
	true|yes|on|1)echo "$2=\"\$$2\";";;
	false|no|off|0)echo "unset $2;";;
	esac
}

unset conf
kill=true
unset lock
unset lock1
unset xss
touch=true
n=
for i in "${@}"; do
	case "$i" in
	--xrdb)
		eval "$(xrdb -query|while read x y; do
		case "$x" in
		xscreensaver.lock:)_bool "$y" lock;;
		esac
		done)"
		n=
	;;
	--nokill)declare "${i#--no}"=false;n='';;
	--test-touch)
		# probably safer for multiple X
		which xinput >/dev/null && {
			xinput list --long|grep -qF 'Touch mode:' || touch=false
		}
		n=
	;;
	--displays)
		pchk(){
			local i r=1
			for i in $(pgrep -x "${1##*/}" -u "$EUID"); do
				grep -xFzw "DISPLAY=$DISPLAY" /proc/"$i"/environ && r=0 && echo $i
			done
			return $r
		}
		_kill(){
			kill $(pchk "$1") 2>/dev/null
		}
		n=
	;;
	--lock|--conf|--sudo1|--sudo2|--xss|--extlock)n="${i#--}";declare $n='';;
	-h|--help)_help;;
	*)
		[ -n "$n" ] && declare $n+="${!n:+ }$i" || _help
		continue
	;;
	esac
done


[ -v conf ] ||
for conf in /etc/xkbd-config.conf @pkgdatadir@/xkbd-kp-f.conf; do
	[ -e $conf ] && break
done

opt="-X -l -D 54 -k $conf -e $0 --nokill"

[ -v xss -a -z "$xss" ] && {
	xssevent $0 "${@}" -xss &
	unset xss
}

if _deflock lock; then
    [ -v xss -a "$xss" != on ] && exit
    $touch && pchk xkbd && touch=false
    if pchk $lock; then
	$touch || exit
    else
	[ -n "$sudo1" ] && sudo -n $sudo1 &
	if [ -n "$sudo2" ]; then
		_lock(){ $lock ; exec sudo -n $sudo2 ; }
		if $touch; then
			_lock &
			pid=$!
		elif $kill; then
			_lock
		else
			_lock &
			sleep 0.5
		fi
	elif $touch; then
		$lock &
		pid=$!
	elif $kill; then
		exec $lock
		#$lock
	else
		$lock &
		sleep 0.5
	fi
	$touch || exit

	# can one fork less, but unsafe to locker bugs
	xkbd $opt &
	pid1+=$!
	if $kill; then
		wait $pid
		_kill
	else
		wait -n $pid $pid1
	fi
	exit

    fi
elif [ -v xss ]; then
	case "$xss" in
	on)exec sudo -n $sudo1;;
	off|disable)
		_deflock extlock && pchk $extlock && exit
		exec sudo -n $sudo2
	;;
	cycle);;
	esac
	exit
else
	$kill && _kill
fi
# around bug in configuring keyboard over xorg.conf
setxkbmap
exec xkbd $opt
