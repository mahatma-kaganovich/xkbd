#!/bin/bash

_help(){
echo "$0: unknown param: $i
Params:
  --nokill
  --lock[-touch] [<lock_program>]
  --sudo{1|2} <cmd>
  --conf <xkbd_config>
Examples:
  $0 --nokill --lock-touch slock - on .Xinitrc
  $0 --lock-touch slock - lock with xkbd
"
exit 1
}

_kill(){
	if [ -x /usr/bin/pkill ]; then
		pkill -x xkbd -u "$EUID" ${@} && exit
	else
		killall -qw xkbd -u "$USER" ${@} && exit
	fi
}

_lock(){
	[ -n "$sudo1" ] && sudo -n $sudo1 &
	$lock1
	[ -n "$sudo2" ] && sudo -n $sudo2 &
}

pchk(){
	pgrep -x "${1##*/}" -u "$EUID" >/dev/null
}

unset conf
kill=true
unset lock
unset lock1
touch=true
n=
for i in "${@}"; do
	case "$i" in
	--nokill)eval "${i#--no}"=false ; n='';;
	--lock-touch)
		# probably safer for multiple X
		which xinput >/dev/null && {
			xinput list --long|grep -qF 'Touch mode:' || touch=false
		}
		n=lock
	;;
	--lock|--conf|--sudo1|--sudo2)n="${i#--}";;
	-h|--help)_help;;
	*)
		[ -n "$n" ] && declare $n+="${!n:+ }$i" || _help
		continue
	;;
	esac
	[ -n "$n" -a ! -v "$n" ] && declare $n=''
done

[ -v conf ] ||
for conf in /etc/xkbd-config.conf @pkgdatadir@/xkbd-kp-f.conf; do
	[ -e $conf ] && break
done

opt="-X -l -D 54 -k $conf -e $0 --nokill"

[ -v lock -a -z "$lock" ] && for lock in /usr/bin/slock; do [ -x "$lock" ] && break;done

if [ -n "$lock" ]; then
    $touch && pchk xkbd && touch=false
    if pchk $lock; then
	$touch || exit
    else
	[ -n "$sudo1$sudo2" ] && {
		lock1="$lock"
		lock=_lock
	}
	$touch || {
		if $kill && [ "$lock" != _lock ]; then
			exec $lock
			$lock
		else
			$lock &
			sleep 0.5
		fi
		exit
	}
	$lock &
	pid=$!
	$kill && {
		xkbd $opt &
		wait $pid
		_kill
		exit
	}
    fi
else
	$kill && _kill
fi
# around bug in configuring keyboard over xorg.conf
setxkbmap
exec xkbd $opt
